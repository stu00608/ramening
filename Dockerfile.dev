FROM node:20-alpine

# è¨­å®šå·¥ä½œç›®éŒ„
WORKDIR /app

# å®‰è£ç³»çµ±ä¾è³´
RUN apk add --no-cache libc6-compat

# è¤‡è£½ package.json å’Œ package-lock.json
COPY package*.json ./

# å®‰è£ä¾è³´
RUN npm ci

# è¤‡è£½ Prisma schema æª”æ¡ˆ
COPY prisma ./prisma

# ç”¢ç”Ÿ Prisma å®¢æˆ¶ç«¯
RUN npx prisma generate

# è¤‡è£½å°ˆæ¡ˆæª”æ¡ˆ
COPY . .

# å»ºç«‹ä¸€å€‹å•Ÿå‹•è…³æœ¬
RUN echo '#!/bin/sh\n\
set -e\n\
echo "ğŸ”§ ç­‰å¾…è³‡æ–™åº«é€£ç·š..."\n\
until npx prisma db push --accept-data-loss --skip-generate >/dev/null 2>&1; do\n\
  echo "â³ ç­‰å¾… PostgreSQL å•Ÿå‹•..."\n\
  sleep 3\n\
done\n\
echo "ğŸ—„ï¸ è³‡æ–™åº« schema å·²åŒæ­¥"\n\
echo "ğŸš€ å•Ÿå‹• Next.js é–‹ç™¼ä¼ºæœå™¨..."\n\
exec npm run dev\n\
' > /app/start.sh && chmod +x /app/start.sh

# æš´éœ²ç«¯å£
EXPOSE 3000

# ä½¿ç”¨å•Ÿå‹•è…³æœ¬
CMD ["/app/start.sh"]